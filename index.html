<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Timer App</title>
    <link rel="stylesheet" href="style.css" />
    <script src="main.js"></script>
    <script>
      // Constants
      const AUDIO_CONFIG = {
        BELL_DURATION: 0.5,
        BASE_FREQUENCY: 880,
        HARMONIC_FREQUENCY: 1320,
        BELL_INTERVAL: 380,
        BELL_ICON: 'üîî',
      };

      const TIMER_CONFIG = {
        DEFAULT_WARNING_COUNT: 3,
        DEFAULT_WARNING_VALUES: [720, 900, 1500],
        MIN_WARNING_COUNT: 1,
        MAX_WARNING_COUNT: 10,
        MAX_SECONDS: 99999999,
        TICK_INTERVAL: 1000,
      };

      const DISPLAY_CONFIG = {
        TIME_UNIT_MINUTE: 'm',
        TIME_UNIT_SECOND: 's',
      };

      // State management
      let timerState = {
        seconds: 0,
        isRunning: false,
        intervalId: null,
        bellsTriggered: [],
        laps: [],
        warningCount: TIMER_CONFIG.DEFAULT_WARNING_COUNT,
        warningValues: [...TIMER_CONFIG.DEFAULT_WARNING_VALUES],
      };

      // UI State
      let lapSectionExpanded = true;
      let settingsVisible = true;

      // DOM elements
      const DOM = {};

      // AudioContextÁÆ°ÁêÜ„É¢„Ç∏„É•„Éº„É´ÔºàÈï∑ÊôÇÈñì„Çø„Ç§„Éû„Éº„ÅÆiOSÂØæÂøúÔºâ
      const AudioContextManager = {
        audioCtx: null,
        keepAliveIntervalId: null,
        KEEP_ALIVE_INTERVAL: 25000, // 25Áßí„Åî„Å®„Å´ÁÑ°Èü≥„ÇíÂÜçÁîü

        // AudioContext„ÇíÂèñÂæóÔºàÈÅÖÂª∂ÂàùÊúüÂåñÔºâ
        getContext() {
          if (!this.audioCtx) {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          return this.audioCtx;
        },

        // AudioContext„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´‰øù„Å§ÁÑ°Èü≥ÂÜçÁîü
        async playKeepAlive() {
          const ctx = this.getContext();

          if (ctx.state === 'suspended') {
            try {
              await ctx.resume();
            } catch (e) {
              console.warn('AudioContext resume failed:', e);
            }
          }

          // ÁÑ°Èü≥„ÇíÁü≠ÊôÇÈñìÂÜçÁîü„Åó„Å¶AudioContext„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´‰øù„Å§
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          gain.gain.value = 0; // ÁÑ°Èü≥
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start();
          osc.stop(ctx.currentTime + 0.001);
        },

        // Keep-alive„ÇíÈñãÂßã
        startKeepAlive() {
          if (this.keepAliveIntervalId) return;

          // Âç≥Â∫ß„Å´‰∏ÄÂ∫¶ÂÆüË°å
          this.playKeepAlive();

          // ÂÆöÊúüÁöÑ„Å´ÂÆüË°å
          this.keepAliveIntervalId = setInterval(() => {
            this.playKeepAlive();
          }, this.KEEP_ALIVE_INTERVAL);
        },

        // Keep-alive„ÇíÂÅúÊ≠¢
        stopKeepAlive() {
          if (this.keepAliveIntervalId) {
            clearInterval(this.keepAliveIntervalId);
            this.keepAliveIntervalId = null;
          }
        },

        // AudioContext„Çí„É¨„Ç∏„É•„Éº„É†
        async resume() {
          const ctx = this.getContext();
          if (ctx.state === 'suspended') {
            await ctx.resume();
          }
          return ctx;
        }
      };

      // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÅÆ„É©„ÉÉ„Éë„ÉºÈñ¢Êï∞
      function getAudioContext() {
        return AudioContextManager.getContext();
      }

      // DOM initialization
      function initializeDOMElements() {
        const elementMap = {
          timerDisplay: 'timer',
          startBtn: 'startBtn',
          pauseBtn: 'pauseBtn',
          resetBtn: 'resetBtn',
          lapBtn: 'lapBtn',
          toggleLapBtn: 'toggleLapBtn',
          lapSection: 'lapSection',
          clearLapsBtn: 'clearLapsBtn',
          lapList: 'lapList',
          settingsDisplayContent: 'settingsDisplayContent',
          warningInputsContainer: 'warningInputsContainer',
          increaseCountBtn: 'increaseCountBtn',
          decreaseCountBtn: 'decreaseCountBtn',
          currentCountSpan: 'currentCount',
          toggleSettingsBtn: 'toggleSettingsBtn',
          settingsInputContent: 'settingsInputContent',
          toggleIcon: 'toggleIcon',
          lapEmptyMessage: 'lapEmptyMessage',
        };

        for (const [key, id] of Object.entries(elementMap)) {
          const element = document.getElementById(id);
          if (!element) {
            console.warn(`DOM element not found: #${id}`);
          }
          DOM[key] = element;
        }
      }
    </script>
  </head>
  <body>
    <div class="container">
      <div class="main-content">
        <div class="top-layout">
          <div class="timer-column">
            <div class="timer-display">
              <div class="time" id="timer">00:00</div>
            </div>
          </div>

          <div class="settings-display-column">
            <div class="settings-display-section">
              <div class="settings-display-content" id="settingsDisplayContent">
                <!-- Dynamically generated warning displays -->
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="btn btn-start" id="startBtn" title="„Çπ„Çø„Éº„Éà">
            ‚ñ∂Ô∏è
          </button>
          <button class="btn btn-pause" id="pauseBtn" disabled title="„Éù„Éº„Ç∫">
            ‚è∏Ô∏è
          </button>
          <button class="btn btn-reset" id="resetBtn" title="„É™„Çª„ÉÉ„Éà">
            üîÑ
          </button>
          <button class="btn btn-lap" id="lapBtn" title="„É©„ÉÉ„Éó">
            <span class="lap-icon">‚è±</span>
            <span class="lap-label">LAP</span>
          </button>
          <button
            class="btn btn-toggle-lap"
            id="toggleLapBtn"
            title="„É©„ÉÉ„ÉóË°®Á§∫ÂàáÊõø"
          >
            ‚â°
          </button>
        </div>

        <div class="lap-section expanded" id="lapSection">
          <div class="lap-header">
            <h2>„É©„ÉÉ„Éó„Çø„Ç§„É†</h2>
            <button
              class="btn-clear-laps"
              id="clearLapsBtn"
              data-label="„ÇØ„É™„Ç¢"
            >
              „ÇØ„É™„Ç¢
            </button>
          </div>
          <div class="lap-list" id="lapList">
            <div class="lap-empty" id="lapEmptyMessage">
              „É©„ÉÉ„Éó„Éú„Çø„É≥„ÇíÊäº„Åô„Å®Ë®òÈå≤„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
            </div>
          </div>
        </div>

        <div class="settings-input-section">
          <div class="settings-input-header">
            <h2>Ë®≠ÂÆö</h2>
            <button class="btn-toggle-settings" id="toggleSettingsBtn">
              <span id="toggleIcon">‚ñº</span>
            </button>
          </div>
          <div class="settings-input-content" id="settingsInputContent">
            <div class="warning-count-control">
              <span class="warning-count-label">„Éô„É´„ÇíÈ≥¥„Çâ„ÅôÂõûÊï∞</span>
              <div class="warning-count-buttons">
                <button class="btn-count" id="decreaseCountBtn" title="Ê∏õ„Çâ„Åô">
                  ‚àí
                </button>
                <span class="current-count" id="currentCount">3</span>
                <button class="btn-count" id="increaseCountBtn" title="Â¢ó„ÇÑ„Åô">
                  +
                </button>
              </div>
            </div>
            <div id="warningInputsContainer">
              <!-- Dynamically generated warning inputs -->
            </div>
            <style id="warningInputStyles">
              .warning-input span {
                color: var(--md3-on-surface-variant);
                font-size: 12px;
                white-space: nowrap;
                flex: 0 0 auto;
              }
            </style>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Initialize app on load
      initializeApp();
    </script>
  </body>
</html>
